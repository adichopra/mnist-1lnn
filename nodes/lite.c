#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>

#include "mnist.h"
// #include "mmio.h"
// #include "nic.h"
// #include "encoding.h"
// #include "vec_mul.h"


// non-vectorized vector multiply
void vec_mul_asm(int n, float result[], float input_X[], float input_Y[]) {
    for (int i = 0; i < n; i += 1) {
        result[i] = input_X[i] * input_Y[i];
    }
}

float dotProduct(float *a, float *b, int length) {
    float result[length];
    vec_mul_asm(length, result, a, b);
    float output = 0;
    for (int i = 0; i < length; i += 1) {
        output += result[i];
    }
    return output;
}

/**
 * Creates an input vector of length NUMBER_OF_INPUT_CELLS
 * of a given MNIST image, setting input vector cells to [0,1]
 * based on the pixels of the image.
 * Scalar pixel intensity [=grey-scale] is ignored, only 0 or 1 [=black-white].
 */

void setCellInput(Cell *c, MNIST_Image *img) {
    for (int i = 0; i < NUMBER_OF_INPUT_CELLS; i += 1) {
        c->input[i] = img->pixel[i] ? 1 : 0;
    }
}

/**
 * Calculates a cell's output by suming all input-weight-products
 * and normalizes to [0-1].
 */

float calcCellOutput(Cell *c) {
    c->output = dotProduct(c->input, c->weight, NUMBER_OF_INPUT_CELLS);
    c->output /= NUMBER_OF_INPUT_CELLS;
    return c->output;
}

void testCell(Cell *c, MNIST_Image *img, int index, tMax *max) {
    if (index == 0) {
        setCellInput(c, img);
        max->idx = 0;
        max->val = calcCellOutput(c);
    } else {
        setCellInput(c, img);
        float output = calcCellOutput(c);
        if (output > max->val) {
            max->val = output;
            max->idx = index;
        }
    }
}

Cell getCell(int index) {
    return (Cell) {.weight = {0.840188, 0.394383, 0.783099, 0.798440, 0.911647, 0.197551, 0.335223, 0.768230, 0.277775, 0.553970, 0.477397, 0.628871, 0.370166, 0.518782, 0.950955, 0.914920, 0.635712, 0.717297, 0.141603, 0.606969, 0.016301, 0.242887, 0.137232, 0.804177, 0.156679, 0.400944, 0.129790, 0.108809, 0.998925, 0.218257, 0.512932, 0.839112, 0.613478, 0.295964, 0.657610, 0.536414, 0.491771, 0.957570, 0.323596, 0.892594, 0.687462, 0.928455, 0.447749, 0.894870, 0.315632, 0.388162, 0.789026, 0.880888, 0.033395, 0.904428, 0.513532, 0.095695, 0.192214, 0.663227, 0.890233, 0.348893, 0.064171, 0.020023, 0.455869, 0.074851, 0.251189, 0.913698, 0.852431, 0.712852, -0.059747, -0.036604, -0.161679, 0.496573, 0.213844, 0.428900, 0.019727, -1.348154, -1.473484, -1.991096, -2.117610, -1.882135, -1.662104, -0.378309, 0.034259, 0.116094, 0.602620, 0.146303, 0.440105, 0.880075, 0.829201, 0.330337, 0.232616, 0.867119, 0.308199, 0.471310, 0.623041, -0.007374, -0.646029, -0.791014, -1.316562, -1.196051, -1.603877, -1.516318, -2.645980, -4.113155, -5.923344, -7.656799, -6.830051, -6.327314, -5.174496, -2.680919, -1.645930, -0.555435, 0.180156, 0.225783, 0.769773, 0.307458, 0.447034, 0.226602, 0.176722, 0.228723, 0.302443, -0.447126, -1.386996, -2.041759, -4.439619, -5.742506, -5.802971, -4.223071, -1.159408, 1.095867, 2.290404, 1.526805, 1.163090, 0.244986, -0.272113, -0.703574, -1.500350, -1.939792, -2.340554, -1.474371, -1.680012, 0.089115, 0.046465, 0.745918, 0.074530, 0.950104, 0.010279, 0.457974, -0.357444, -1.258035, -1.805652, -3.278907, -4.490087, -5.005198, -4.384089, -2.749097, 0.094359, 3.899941, 6.089061, 5.949584, 5.193923, 4.109821, 3.164015, 1.607757, -0.092268, -1.690219, -3.937474, -4.737909, -3.958015, -2.073860, 0.373748, 0.098018, 0.997799, 0.045142, 0.810171, 0.026779, -0.503990, -0.299943, -1.716758, -2.276740, -3.351323, -3.224338, -1.315567, 0.686542, 2.035401, 4.674557, 6.168356, 7.042685, 6.506139, 5.449562, 4.600092, 3.255095, 0.301737, -1.870268, -3.856915, -5.072632, -7.401937, -3.882818, -1.165540, 0.653697, 0.832909, 0.910550, 0.829722, 0.608549, -0.111762, -0.787477, -1.009565, -1.123645, -0.240981, -0.811463, -0.716781, 0.929592, 3.387098, 4.843624, 7.776630, 7.674192, 8.316896, 8.338703, 7.519178, 4.378051, 0.468493, -3.680539, -6.232639, -6.208707, -9.683224, -5.911873, -1.285126, 0.866320, 0.321424, 0.535587, 0.454515, -0.699666, -1.568305, -2.109647, -1.070218, -0.872572, -0.842742, -1.789662, -1.458616, -0.870970, 2.441067, 5.504606, 7.509404, 7.966602, 9.081215, 10.134531, 9.151404, 6.270704, 3.743223, 0.195852, -2.594460, -4.227989, -8.168918, -6.421122, -1.005481, 0.553755, 0.352501, 0.143894, 0.176308, -0.705194, -2.098316, -2.751321, -1.355952, -0.600054, -0.382232, -0.186345, 0.874481, 2.787661, 4.796310, 5.142281, 5.801027, 8.254192, 9.903391, 8.622268, 10.208048, 9.415048, 6.772030, 5.727614, 3.028611, 1.573041, -3.932055, -5.473651, -1.224667, 0.092251, 0.986741, -0.057834, 0.209326, -1.383397, -3.619543, -2.557491, -0.897660, -0.633015, -0.521056, -0.226604, 2.750835, 3.774794, 1.169726, 1.706754, 1.628499, 3.751492, 3.579424, 4.164667, 8.001142, 8.142868, 8.304435, 9.982509, 9.072387, 9.513106, 0.753795, -3.110116, -0.843839, 0.206914, 0.868268, 0.478039, -0.095437, -1.006926, -3.572572, -1.978164, -0.819900, -0.527897, -1.078027, 1.911976, 3.426076, 0.764412, -1.724389, -3.163176, -3.506888, -3.026648, -1.421863, -2.527554, -0.910372, 2.351529, 6.426196, 12.220769, 13.657004, 14.458511, 5.338850, -1.126691, -0.050655, 0.309110, 0.394454, 0.660134, 0.210786, -1.467156, -3.236331, 0.381279, 0.023635, 0.794973, 1.401341, 4.756243, 3.917005, -0.119137, -3.870041, -4.956390, -8.472266, -7.404450, -7.231621, -10.066982, -8.842024, -4.912423, 1.381018, 9.207063, 15.204587, 15.851554, 7.150709, -0.424307, 0.672836, 0.384063, 0.247024, 0.329584, 0.562411, -0.742545, -1.493182, 2.507715, 3.092778, 1.927490, 4.190063, 6.312392, 5.676937, 0.267883, -6.376805, -8.567781, -11.889756, -10.165145, -13.713204, -16.868909, -14.896501, -10.122966, -2.133527, 8.822859, 15.065065, 14.195382, 5.939084, -0.574473, 0.204359, 0.628622, 0.806798, 0.109926, -0.069038, -1.396858, -0.711227, 5.366630, 5.709464, 5.489346, 7.116223, 7.888254, 5.733090, -0.727026, -6.869276, -9.916320, -12.337219, -11.043692, -14.656045, -17.380520, -12.931829, -8.654801, -1.075197, 7.598830, 11.434517, 11.191303, 4.017549, -1.171411, 0.817601, 0.164838, 0.475629, 0.221481, 0.687040, -1.307972, 0.200815, 6.036678, 5.517162, 7.442425, 9.291630, 8.433393, 6.060390, -1.256315, -7.936686, -10.462867, -11.887315, -12.488286, -13.716695, -11.535976, -7.938434, -3.637662, 1.764149, 7.598519, 7.609335, 6.230469, 2.438457, -0.771178, 0.057799, 0.372779, 0.529040, 0.156596, 0.351573, -2.191566, 1.114081, 6.934999, 5.934891, 8.631850, 8.207953, 7.654375, 3.797283, -3.176541, -10.045423, -11.578259, -12.001218, -9.589036, -9.105275, -5.851821, -3.665707, 1.032775, 5.065694, 4.476256, 2.912910, 2.661586, 1.671811, -0.378224, 0.602675, 0.732987, 0.152876, 0.028876, -0.238203, -2.469755, 0.387646, 6.400301, 4.992651, 6.421922, 6.037503, 4.830828, 2.277173, -6.553718, -9.189144, -9.715292, -9.668643, -7.235548, -4.183506, -1.765900, -0.299559, 3.491148, 4.711133, 1.074121, -1.385895, 0.985014, 0.830535, -0.340654, 0.783418, 0.212459, 0.399147, 0.701170, 0.396255, -3.712703, -0.505222, 5.005376, 3.039590, 5.116400, 4.975515, 4.958662, 2.742844, -3.653902, -4.538397, -3.429918, -2.464457, -2.191567, -1.641004, -0.411899, 2.448892, 3.131461, 1.119557, -2.189524, -1.550749, -1.060621, -0.008464, -0.000620, 0.146997, 0.559949, 0.470475, 0.214619, 0.178147, -3.716316, -1.271891, 2.177135, 1.520848, 1.953932, 3.196055, 4.708061, 5.751873, 3.770416, 3.816022, 2.494146, 1.697028, 0.679342, 0.161550, 0.447623, 0.523635, 0.092990, -3.244017, -3.383707, -2.098290, -1.948004, -0.270946, -0.033135, 0.013521, 0.397921, 0.247033, 0.431176, -0.641933, -3.776802, -3.038071, 0.359464, -1.170397, -0.207872, 1.241209, 4.380563, 6.565019, 8.326370, 8.186089, 6.310235, 2.451983, 1.179981, 0.527100, 1.221387, -1.108802, -3.623093, -4.519347, -2.706521, -2.285406, -1.648929, -0.227543, 0.719298, 0.332748, 0.532809, 0.219988, 0.456974, 0.371283, -3.055128, -3.086499, -0.959530, -2.144964, -1.040698, 0.643185, 2.988082, 4.402890, 4.748835, 4.395168, 3.956276, 2.240318, 2.510924, 2.430072, 0.293466, -2.291770, -3.154457, -2.789197, -2.653528, -2.074036, -0.923185, -0.562890, 0.645844, 0.955654, 0.125543, 0.374408, 0.194949, 0.242422, -1.739972, -2.255511, -1.175346, -1.519615, -0.077631, 2.076701, 3.832909, 5.572770, 6.382852, 5.284616, 6.321872, 6.738763, 6.316285, 2.947653, 1.018762, -1.574757, -1.182982, -1.212012, -1.500647, -1.062550, 0.009436, 0.029393, 0.375142, 0.941636, 0.381794, 0.899431, 0.747638, 0.296389, -0.808482, -1.309966, -1.227090, -0.474796, 0.501727, 1.961683, 4.318413, 6.032229, 7.532651, 7.871685, 8.402589, 7.768525, 4.773258, 4.109714, 2.772357, 2.256155, -0.126288, -0.783612, -1.108796, -0.755894, 0.080741, 0.867690, 0.086128, 0.599069, 0.070557, 0.393746, 0.496431, 0.377650, 0.029556, -0.289481, -0.151557, -1.710827, -3.276760, -5.056344, -5.903124, -6.942304, -6.801899, -6.242827, -4.670649, -3.055882, -1.016660, 0.257708, 1.954730, 2.073847, 1.415118, 0.863474, 0.125033, -0.260642, -0.282362, 0.745757, 0.814167, 0.707737, 0.681922, 0.904187, 0.312940, 0.733099, 0.294539, 0.659146, -0.438206, -1.042057, -2.992570, -4.529108, -5.953781, -7.073183, -7.595266, -6.586118, -5.766000, -3.040595, -1.027264, -0.946525, 0.596801, 0.435695, 0.324167, 0.359962, -0.216573, 0.206087, 0.238273, 0.753303, 0.931094, 0.530534, 0.582250, 0.729398, 0.225236, 0.264172, 0.630654, 0.479999, -0.273087, 0.124956, -1.177830, -2.388584, -2.829839, -3.439166, -3.506603, -2.858877, -2.770228, -2.577058, -2.090250, -1.249746, -0.854142, -0.224950, 0.554035, 0.075332, 0.437427, -0.186768, 0.740239, 0.845172, 0.599311, 0.321478, 0.667960, 0.526830, 0.848000, 0.250210, 0.256228, 0.052047, 0.467616, 0.768144, 0.400330, 0.239789, 0.482253, 0.478333, 0.188169, -0.435770, -0.659146, -0.982799, -0.874150, -0.710832, -0.049201, -0.042239, 0.541486, 0.732959, 0.390605, 0.407692, 0.040811, 0.190984, 0.483648, 0.923381, 0.043395}};
}

void compute_and_store_result(Message *msg, Cell *c0, Cell *c1) {
    MNIST_Image img = msg->img;
    tMax max = msg->max;

    testCell(c0, &img, 0, &max);
    testCell(c1, &img, 1 + 1, &max);

    Message msg2 = (Message) {.img = img, .max = max};
}

int main(int argc, const char * argv[]) {
    MNIST_Image img = (MNIST_Image) {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,84,185,159,151,60,36,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,222,254,254,254,254,241,198,198,198,198,198,198,198,198,170,52,0,0,0,0,0,0,0,0,0,0,0,0,67,114,72,114,163,227,254,225,254,254,254,250,229,254,254,140,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,17,66,14,67,67,67,59,21,236,254,106,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,83,253,209,18,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,22,233,255,83,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,129,254,238,44,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,59,249,254,62,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,133,254,187,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,9,205,248,58,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,126,254,182,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,75,251,240,57,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,19,221,254,166,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,203,254,219,35,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,38,254,254,77,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,31,224,254,115,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,133,254,254,52,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,61,242,254,254,52,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,121,254,254,219,40,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,121,254,207,18,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};
    tMax max = (tMax) {.val = 0, .idx = 0};
    Message msg = (Message) {.img = img, .max = max};

    Cell c0 = getCell(0);
    Cell c1 = getCell(1);
    
    compute_and_store_result(&msg, &c0, &c1);
    printf("done\n");
    return 0;
}